const fs = require("fs")
const Path = require("path")

const prog    = Path.relative(process.cwd(), __filename)
const infile  = "src/common/figpad-env.d.ts"
const outfile = "src/figma-plugin/scriptenv.d.ts"

process.chdir(__dirname + "/..")
let a = fs.readFileSync(infile, "utf8")
let b = (
  `// Automatically generated from ${infile} by ${prog}.\n` +
  `// Do not edit manually -- instead, run ${prog}\n` +
  "\n" +
  "export type ScriptEnv = typeof scriptenv\n" +
  "declare namespace scriptenv {\n" +

  // a.replace(/\n\s*declare/g, "\n") +

  a.replace(/declare\s*global\s*\{/, "\n")
   .replace(/\}\s*\/\/\s*declare\s*global[^\n\r]*/, "\n")
   .replace(/export\s*\{\};?/, "\n")
   .replace(/\/\/\/\s*<[^\r\n]+/, "\n")
   +

  "}\n"
)

// let b = (
//   `// Automatically generated by ${prog}.\n` +
//   `// Do not edit manually -- instead, run ${prog}\n` +
//   "\n" +
//   "export const __esmodule :bool\n" +
//   a.replace(/\n\s*declare/g, "\nexport")
// )

let b1 = ""
try {
  b1 = fs.readFileSync(outfile, "utf8")
} catch (_) {}
if (b1 != b) {
  console.log(`${prog}: write ${outfile}`)
  fs.writeFileSync(outfile, b, "utf8")
}
